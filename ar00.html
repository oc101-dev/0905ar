<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- A-Frame を読み込む -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <!-- AR.js を読み込む -->
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <title>AR 002</title>
    <script>
      window.onload = function() {
        AFRAME.registerComponent('interactive-object', {
          schema: {
            minScale: { type: 'number', default: 0.2 },
            maxScale: { type: 'number', default: 10.0 },
            rotationSensitivity: { type: 'number', default: 5.0 },
            scaleSensitivity: { type: 'number', default: 1.0 }
          },

          init: function() {
            this.scale = 1.0;
            this.rotation = 0;
            this.initialScale = this.el.object3D.scale.clone();
            
            // マウス操作用の変数
            this.isDragging = false;
            this.previousMousePosition = { x: 0, y: 0 };
            
            // イベントリスナーの設定
            this.el.sceneEl.addEventListener('mousedown', this.onMouseDown.bind(this));
            this.el.sceneEl.addEventListener('mousemove', this.onMouseMove.bind(this));
            this.el.sceneEl.addEventListener('mouseup', this.onMouseUp.bind(this));
            this.el.sceneEl.addEventListener('wheel', this.onWheel.bind(this));
            
            // タッチ操作用の変数
            this.touchCache = [];
            this.previousTouchDistance = 0;
            
            // タッチイベントリスナーの設定
            this.el.sceneEl.addEventListener('touchstart', this.onTouchStart.bind(this));
            this.el.sceneEl.addEventListener('touchmove', this.onTouchMove.bind(this));
            this.el.sceneEl.addEventListener('touchend', this.onTouchEnd.bind(this));
          },

          // マウス操作のハンドラー
          onMouseDown: function(event) {
            this.isDragging = true;
            this.previousMousePosition = {
              x: event.clientX,
              y: event.clientY
            };
          },

          onMouseMove: function(event) {
            if (!this.isDragging) return;
            
            const deltaX = event.clientX - this.previousMousePosition.x;
            this.rotation += deltaX * 0.01 * this.data.rotationSensitivity;
            this.el.object3D.rotation.y = this.rotation;
            
            this.previousMousePosition = {
              x: event.clientX,
              y: event.clientY
            };
          },

          onMouseUp: function() {
            this.isDragging = false;
          },

          onWheel: function(event) {
            event.preventDefault();
            const scaleDelta = 1 - Math.sign(event.deltaY) * 0.1;
            this.updateScale(scaleDelta);
          },

          // タッチ操作のハンドラー
          onTouchStart: function(event) {
            event.preventDefault();
            this.touchCache = Array.from(event.touches);
            
            if (event.touches.length === 2) {
              this.previousTouchDistance = this.getTouchDistance(this.touchCache[0], this.touchCache[1]);
            }
          },

          onTouchMove: function(event) {
            event.preventDefault();
            
            if (event.touches.length === 1) {
              // 回転操作
              const touch = event.touches[0];
              const previousTouch = this.touchCache[0];
              
              if (previousTouch) {
                const deltaX = touch.clientX - previousTouch.clientX;
                this.rotation += deltaX * 0.01 * this.data.rotationSensitivity;
                this.el.object3D.rotation.y = this.rotation;
              }
            } 
            else if (event.touches.length === 2) {
              // ピンチ操作による拡大縮小
              const currentDistance = this.getTouchDistance(event.touches[0], event.touches[1]);
              
              if (this.previousTouchDistance > 0) {
                const scaleDelta = currentDistance / this.previousTouchDistance;
                this.updateScale(scaleDelta);
              }
              
              this.previousTouchDistance = currentDistance;
            }
            
            this.touchCache = Array.from(event.touches);
          },

          onTouchEnd: function(event) {
            event.preventDefault();
            this.touchCache = Array.from(event.touches);
            
            if (event.touches.length < 2) {
              this.previousTouchDistance = 0;
            }
          },

          // ユーティリティ関数
          getTouchDistance: function(touch1, touch2) {
            const dx = touch1.clientX - touch2.clientX;
            const dy = touch1.clientY - touch2.clientY;
            return Math.sqrt(dx * dx + dy * dy);
          },

          updateScale: function(scaleDelta) {
            const newScale = this.scale * scaleDelta;
            
            if (newScale >= this.data.minScale && newScale <= this.data.maxScale) {
              this.scale = newScale;
              this.el.object3D.scale.copy(this.initialScale.clone().multiplyScalar(this.scale));
            }
          }
        });
      };
    </script>
  </head>
  <body style="margin: 0; overflow: hidden">
	  
    <!-- A-FrameにAR.jsを紐づけ、VRボタン非表示、深度バッファ追加 -->
    <a-scene embedded arjs vr-mode-ui="enabled: false;" renderer="logarithmicDepthBuffer: true; colorManagement: true; physicallyCorrectLights: true;">
	    
      <!-- 3DCGモデルを読み込む -->
      <a-assets>
        <a-asset-item id="bob" src="./asset/bob.glb"></a-asset-item>
        <a-asset-item id="tori" src="./asset/tori.glb"></a-asset-item>

      </a-assets>

      <!-- ライティング設定 -->
      <a-entity light="type: ambient; intensity: 2.5; color: #ffffff"></a-entity>
      <a-entity light="type: directional; intensity: 2.0; color: #ffffff" position="-1 1 0.5"></a-entity>
      <a-entity light="type: hemisphere; intensity: 1.5; color: #ffffff; groundColor: #888888"></a-entity>

      <!-- マーカーの.pattファイルを読み込む -->
      <a-marker type="pattern" url="./asset/pattern-marker.patt">
        <!-- 3Dモデルを呼び出す -->
        <a-entity 
          gltf-model="#bob" 
          rotation="0 -90 90" 
          scale="1 1 1" 
          position="0 0 0"
          interactive-object="minScale: 0.2; maxScale: 10.0; rotationSensitivity: 5.0; scaleSensitivity: 1.0">
        </a-entity>
        <a-entity 
          gltf-model="#tori" 
          rotation="-90 0 0" 
          scale="1 1 1" 
          position="1 0 0"
          interactive-object="minScale: 0.2; maxScale: 10.0; rotationSensitivity: 5.0; scaleSensitivity: 1.0">
        </a-entity>
      </a-marker>

      <!-- カメラを追加 -->
      <a-entity camera></a-entity>
    </a-scene>
  </body>


</html>